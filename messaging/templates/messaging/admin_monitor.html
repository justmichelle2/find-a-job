{% extends 'base.html' %}

{% block title %}Monitor Conversations - Admin{% endblock %}

{% block content %}
<div class="container">
    <h2 class="mb-4"><i class="bi bi-shield-check"></i> Admin: Monitor Conversations</h2>
    
    <div class="alert alert-info">
        <i class="bi bi-info-circle"></i> All conversations are visible to ensure business compliance. You can deactivate conversations or flag inappropriate messages.
    </div>
    
    <div class="mb-3">
        <a href="?show_inactive=1" class="btn btn-secondary btn-sm">
            {% if request.GET.show_inactive %}Hide{% else %}Show{% endif %} Inactive Conversations
        </a>
    </div>
    
    {% if flagged_messages %}
    <div class="card mb-4 border-danger">
        <div class="card-header bg-danger text-white">
            <h5 class="mb-0"><i class="bi bi-flag-fill"></i> Flagged Messages ({{ flagged_messages|length }})</h5>
        </div>
        <div class="card-body">
            {% for msg in flagged_messages %}
            <div class="alert alert-warning">
                <strong>From:</strong> {{ msg.sender.username }}<br>
                <strong>Conversation:</strong> {{ msg.conversation }}<br>
                <strong>Message:</strong> {{ msg.content }}<br>
                <strong>Time:</strong> {{ msg.timestamp }}<br>
                <form method="post" action="{% url 'messaging:admin_flag_message' msg.pk %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-success mt-2">Unflag</button>
                </form>
                <form method="post" action="{% url 'messaging:admin_deactivate' msg.conversation.pk %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-danger mt-2">Deactivate Conversation</button>
                </form>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <h4 class="mb-3">All Conversations</h4>
    {% if conversations %}
        {% for conv in conversations %}
        <div class="card mb-3 {% if not conv.is_active %}border-secondary{% endif %}">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h5 class="card-title">
                            {{ conv.participant_1.username }} & {{ conv.participant_2.username }}
                        </h5>
                        <p class="text-muted mb-2">
                            <small><i class="bi bi-briefcase"></i> {{ conv.application.job.title }}</small>
                        </p>
                        <p class="mb-2">
                            <strong>Messages:</strong> {{ conv.messages.count }}
                        </p>
                        {% if not conv.is_active %}
                            <span class="badge bg-secondary">Deactivated</span>
                        {% endif %}
                    </div>
                    <div>
                        {% if conv.is_active %}
                            <form method="post" action="{% url 'messaging:admin_deactivate' conv.pk %}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-danger btn-sm">
                                    <i class="bi bi-x-circle"></i> Deactivate
                                </button>
                            </form>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Show recent messages -->
                <div class="mt-3">
                    <strong>Recent messages:</strong>
                    {% for msg in conv.messages.all|slice:":3" %}
                    <div class="p-2 bg-light rounded mb-2">
                        <small>
                            <strong>{{ msg.sender.username }}:</strong> {{ msg.content|truncatewords:15 }}<br>
                            <span class="text-muted">{{ msg.timestamp|timesince }} ago</span>
                            {% if not msg.flagged_by_admin %}
                                <form method="post" action="{% url 'messaging:admin_flag_message' msg.pk %}" class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-outline-warning ms-2">Flag</button>
                                </form>
                            {% else %}
                                <span class="badge bg-warning">Flagged</span>
                                <form method="post" action="{% url 'messaging:admin_flag_message' msg.pk %}" class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-outline-success ms-2">Unflag</button>
                                </form>
                            {% endif %}
                        </small>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> No conversations to monitor.
        </div>
    {% endif %}
</div>
{% endblock %}
